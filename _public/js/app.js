"use strict";var App;App=angular.module("app",["ngCookies","ngResource","ngRoute","ui.bootstrap","ngSanitize","app.services","app.controllers","app.directives","app.filters","app.animations","partials"]),App.config(["$routeProvider","$locationProvider",function(t,e){return t.when("/welcome",{templateUrl:"/partials/welcome.html",controller:"WelcomeCtrl"}).when("/list",{templateUrl:"/partials/list.html",controller:"ListCtrl"}).when("/act",{templateUrl:"/partials/act.html",controller:"ActCtrl"}).when("/manage",{templateUrl:"/partials/manage.html",controller:"ManageCtrl"}).when("/help",{templateUrl:"/partials/help.html",controller:"HelpCtrl"}).otherwise({redirectTo:"/welcome"}),e.html5Mode(!1)}]),angular.module("app.animations",["ngAnimate"]).animation(".phone",function(){return{event:function(){return alert(11)}}});var BasedataFile,ConfigPath,ImagePath,WorkspacePath,config,help;config={redirect:{"/welcome":{37:"/manage",39:"/act"},"/act":{40:"/list",38:"/list"},"/list":{38:"/act",40:"/act"},"/manage":{38:"/help",40:"/help"},"/help":{38:"/manage",40:"/manage"}}},ConfigPath="./JoyLotteryPath",BasedataFile="/basedata.json",WorkspacePath="/workspace",ImagePath="/image",Array.prototype.contains=function(t){var e,r,a;for(r=0,a=this.length;a>r;r++)if(e=this[r],e===t)return!0;return!1},String.prototype.endWith=function(t){return null===t||""===t||0===this.length||t.length>this.length?!1:this.substring(this.length-t.length)===t?!0:!1},String.prototype.startWith=function(t){return null===t||""===t||0===this.length||t.length>this.length?!1:this.substr(0,t.length)===t?!0:!1},help=[{key:"Alt + s",act:"保存工作空间"},{key:"Alt + o",act:"在抽奖页面中，打开奖品图片"},{key:"ESC",act:"在非欢迎页面：回到欢迎页面；<br/>在抽奖页面，奖品图片打开时，关闭奖品页面"},{key:"space",act:"在抽奖页面，开始或停止抽奖进程。在0.5秒内连续点击两次无效。"},{key:"欢迎页面",act:"Alt + &larr;：基础数据管理页面；<br/> Alt + &rarr;：抽奖页面；"},{key:"抽奖页面",act:"Alt + &larr;：上一个奖项；<br/> Alt + &rarr;：下一个奖项；<br/> Alt + &uarr; and &darr;：中奖名单;"},{key:"中奖名单页面",act:"Alt + &uarr; and &darr;：抽奖页面;"},{key:"基础数据管理页面",act:"Alt + &uarr; and &darr;：帮助页面;"},{key:"帮助页面",act:"Alt + &uarr; and &darr;：基础数据管理页面;"}],angular.module("app.controllers",[]).controller("AppCtrl",["$scope","$location","$resource","$rootScope","LotteryRoute","LotteryDao","WorkspaceService","$interval","$timeout",function(t,e,r,a,n,o,s,i,l){return a.loaded=!1,a.isAct=!0,t.keydown=function(t){var r;return a.modalOpen||8===t.keyCode?void t.preventDefault():(n.route(t),a.timer=null,a.timer&&l.cancel(a.timer),32===t.keyCode&&"/act"===e.path()&&a.isAct&&(a||alert("请等待数据加载"),a.Workspace.activate?s.stop():s.start(),a.isAct=!1,r=l(function(){return a.isAct=!0},500)),27===t.keyCode?e.path("/welcome"):void 0)}}]).controller("WelcomeCtrl",["$rootScope","$scope","WorkspaceService","LotteryDao",function(t,e,r,a){var n,o;return o=require("fs"),o.existsSync(ConfigPath)&&(n=o.readFileSync(ConfigPath),t.BasePath=n.toString(),!t.loaded)?(r.updatePathConfig(),a.getBaseData()):void 0}]).controller("ActCtrl",["$rootScope","$scope","WorkspaceService","LotteryDao","$modal",function(t,e,r,a){return e.prize=r.getActivePrize(),t.actScope=e,e.changeSlotState=function(t){var e;return e=t.state,t.state=1===e?2:2===e?1:0,a.saveWorkspace()},e.getSlotClass=function(t){var e;return 2===t?e="chosen":void 0}}]).controller("ModalCtrl",["$scope","$modalInstance","image","$rootScope",function(t,e,r,a){return t.image=r,a.modalOpen=!0}]).controller("ListCtrl",["$rootScope","$scope","WorkspaceService",function(t,e){return e.prizes=t.Workspace.prizes}]).controller("ManageCtrl",["$rootScope","$scope","WorkspaceService","LotteryDao",function(t,e,r,a){return t.BasePath&&(e.BasePath=t.BasePath),t.loaded?(e.prizes=t.BaseData.prizes,e.baseCandidates=t.BaseData.baseCandidates):t.$watch("loaded",function(r){return r?(e.prizes=t.BaseData.prizes,e.baseCandidates=t.BaseData.baseCandidates):void 0}),e.$watch("BasePath",function(n){var o;return o=require("fs"),o.existsSync(n+BasedataFile)?(o.writeFileSync(ConfigPath,n),t.BasePath=n,r.updatePathConfig(),t.loaded||(r.updatePathConfig(),a.getBaseData()),e.error_text=""):e.error_text="请输入正确的基础数据路径"})}]).controller("HelpCtrl",["$scope",function(t){return t.help=help}]);var DataStore,createDocumentStore,createRelationalStore,createSimpleStore;DataStore="undefined"!=typeof exports&&null!==exports&&exports||(this.DataStore={}),DataStore.create=function(t){switch(t){case"simple":return createSimpleStore();case"relational":return createRelationalStore();case"document":return createDocumentStore();default:return void 0}},createSimpleStore=function(){return{get:function(t){return JSON.parse(localStorage.getItem(JSON.stringify(t)))},set:function(t,e){return localStorage.setItem(JSON.stringify(t),JSON.stringify(e))},"delete":function(t){return localStorage.removeItem(JSON.stringify(t))},count:function(){return localStorage.length},clear:function(){return localStorage.clear()}}},createRelationalStore=function(){var t,e;return t=openDatabase("nwsqldb","1.0","embedded sql database",268435456),e={run:function(e,r){return t.transaction(function(t){return t.executeSql(e,[],function(t,e){var a;return"function"==typeof r?r(function(){var t,r,n;for(n=[],a=t=0,r=e.rows.length;r>=0?r>t:t>r;a=r>=0?++t:--t)n.push(e.rows.item(a));return n}()):void 0})})}}},createDocumentStore=function(){var t,e,r,a;try{return t=require("nedb"),e=require("nw.gui").App.dataPath+"/nedb",a={collection:function(e){return new t({filename:"/"+e,autoload:!0})}}}catch(n){return r=n,console.error("MODULE_NOT_FOUND"===r.code?"NeDB not found. Try `npm install nedb --save` inside of `/app/assets`.":r)}},angular.module("app.directives",["app.services"]).directive("appVersion",["version",function(t){return function(e,r){return r.text(t)}}]),angular.module("app.filters",[]).filter("interpolate",["version",function(t){return function(e){return String(e).replace(/\%VERSION\%/gm,t)}}]),angular.module("app.services",[]).factory("version",function(){return"0.1"}).factory("LotteryRoute",["$location","WorkspaceService","$rootScope","$route","LotteryDao","$modal",function(t,e,r,a,n,o){return{redirect_rule:config.redirect,route:function(s){var i;if(s.altKey){if(i=require("fs"),"/act"===t.path()&&79===s.keyCode)return r.modalInstance=o.open({template:"<img ng-src='{{image}}' width='500px' height='500px'/>",controller:"ModalCtrl",size:"sm",resolve:{image:function(){return e.getActivePrize().image}}}),void r.modalInstance.result.then(function(){return""},function(){return r.modalOpen=!1});if("/act"===t.path()&&83===s.keyCode)return void n.saveWorkspace();if(!r.BasePath||!i.existsSync(r.BasePath))return void t.path("/manage");if(!r.loaded)return void t.path("/manager");if("/act"===t.path()){if(!e.isCurrentPrizeDone())return;37===s.keyCode?(r.Workspace.activePrizeId=e.setActivePrizeId(!1),a.reload()):39===s.keyCode&&(r.Workspace.activePrizeId=e.setActivePrizeId(!0),a.reload())}return t.path(this.redirect_rule[t.path()][s.keyCode])}}}}]).factory("LotteryDao",["$http","$rootScope",function(t,e){return{saveBaseData:function(){var t;return t=require("fs"),t.writeFile(e.BasedataPath+"/basedata.json",JSON.stringify(e.BaseData),function(t){return t?alert("工作空间数据保存失败"+t):void 0})},getBaseData:function(){var t,r,a,n;return r=this.getWorkspace,a=this.initWorkspace,n=this.saveWorkspace,t=require("fs"),t.exists(e.BasedataFile,function(o){return o?t.readFile(e.BasedataFile,function(t,o){return t&&alert("读取基础数据文件出错"),e.BaseData=JSON.parse(o),r(a,n)}):alert("基础数据文件不存在")})},getWorkspace:function(t,r){var a,n,o;return n=require("fs"),a=n.readdirSync(e.WorkspacePath),o=[],a.forEach(function(t){return t.endWith(".json")?o.push(t):void 0}),o.length>0&&(e.Workspace=JSON.parse(n.readFileSync(e.WorkspacePath+"/"+o.sort()[o.length-1]))),e.Workspace?e.loaded=!0:t(r)},initWorkspace:function(t){var r,a,n,o,s,i,l,c;for(e.Workspace={prizes:e.BaseData.prizes,baseCandidates:e.BaseData.baseCandidates,activePrizeId:0,waivers:[],candidates:[],activate:!1},l=e.Workspace.prizes,o=0,i=l.length;i>o;o++)for(a=l[o],a.image=e.ImagePath+"/"+a.image,a.slots=[],r=s=1,c=a.capacity;c>=1?c>=s:s>=c;r=c>=1?++s:--s)n={id:r,number:-1,interval:null,activate:!1,state:0},a.slots.push(n);return t(),e.loaded=!0},saveWorkspace:function(){var t,r;return t=require("fs"),r=(new Date).getTime(),t.writeFile(e.WorkspacePath+"/"+r+".json",JSON.stringify(e.Workspace),function(t){return t&&alert("工作空间数据保存失败"+t),e.Workspace.lastVersion=r})},backupWorkspace:function(){return alert("backupWorkspace")}}}]).factory("WorkspaceService",["$rootScope","$interval","LotteryDao",function(t,e,r){return{setActivePrizeId:function(e){var r,a,n;return n=t.Workspace.activePrizeId,a=t.Workspace.prizes.length-1,r=e?a>n?n+1:0:0===n?a:n-1},getActivePrize:function(){var e,r,a,n,o;for(o=t.Workspace.prizes,a=0,n=o.length;n>a;a++)r=o[a],r.id===t.Workspace.activePrizeId&&(e=r);return e},start:function(){var r,a,n,o,s,i,l,c,u;a=this.getActivePrize(),n=this.random,r=this.candidatesArray();try{if(!a.complete_once){for(c=a.slots,u=[],i=0,l=c.length;l>i;i++){if(s=c[i],0===s.state||2===s.state){s.interval=e(function(){return s.number=n(r)},10),s.activate=!0;break}u.push(void 0)}return u}if(o=a.slots.length,1!==a.slots[0].state&&(a.slots[0].interval=e(function(){return a.slots[0].number=n(r)},10)),1!==a.slots[1].state&&(a.slots[1].interval=e(function(){return a.slots[1].number=n(r)},10)),1!==a.slots[2].state&&(a.slots[2].interval=e(function(){return a.slots[2].number=n(r)},10)),1!==a.slots[3].state&&(a.slots[3].interval=e(function(){return a.slots[3].number=n(r)},10)),1!==a.slots[4].state&&(a.slots[4].interval=e(function(){return a.slots[4].number=n(r)},10)),1!==a.slots[5].state&&(a.slots[5].interval=e(function(){return a.slots[5].number=n(r)},10)),1!==a.slots[6].state&&(a.slots[6].interval=e(function(){return a.slots[6].number=n(r)},10)),1!==a.slots[7].state&&(a.slots[7].interval=e(function(){return a.slots[7].number=n(r)},10)),1!==a.slots[8].state&&(a.slots[8].interval=e(function(){return a.slots[8].number=n(r)},10)),1!==a.slots[9].state&&(a.slots[9].interval=e(function(){return a.slots[9].number=n(r)},10)),1!==a.slots[10].state&&(a.slots[10].interval=e(function(){return a.slots[10].number=n(r)},10)),1!==a.slots[11].state&&(a.slots[11].interval=e(function(){return a.slots[11].number=n(r)},10)),1!==a.slots[12].state&&(a.slots[12].interval=e(function(){return a.slots[12].number=n(r)},10)),1!==a.slots[13].state&&(a.slots[13].interval=e(function(){return a.slots[13].numberw=n(r)},10)),1!==a.slots[14].state&&(a.slots[14].interval=e(function(){return a.slots[14].number=n(r)},10)),1!==a.slots[15].state&&(a.slots[15].interval=e(function(){return a.slots[15].number=n(r)},10)),1!==a.slots[16].state&&(a.slots[17].interval=e(function(){return a.slots[16].number=n(r)},10)),1!==a.slots[17].state&&(a.slots[17].interval=e(function(){return a.slots[17].number=n(r)},10)),1!==a.slots[18].state&&(a.slots[18].interval=e(function(){return a.slots[18].number=n(r)},10)),1!==a.slots[19].state&&(a.slots[19].interval=e(function(){return a.slots[19].number=n(r)},10)),1!==a.slots[20].state&&(a.slots[20].interval=e(function(){return a.slots[20].number=n(r)},10)),1!==a.slots[21].state&&(a.slots[21].interval=e(function(){return a.slots[21].number=n(r)},10)),1!==a.slots[22].state&&(a.slots[22].interval=e(function(){return a.slots[22].number=n(r)},10)),1!==a.slots[23].state&&(a.slots[23].interval=e(function(){return a.slots[23].number=n(r)},10)),1!==a.slots[24].state&&(a.slots[24].interval=e(function(){return a.slots[24].number=n(r)},10)),1!==a.slots[25].state&&(a.slots[25].interval=e(function(){return a.slots[25].number=n(r)},10)),1!==a.slots[26].state&&(a.slots[26].interval=e(function(){return a.slots[26].number=n(r)},10)),1!==a.slots[27].state&&(a.slots[27].interval=e(function(){return a.slots[27].number=n(r)},10)),1!==a.slots[28].state&&(a.slots[28].interval=e(function(){return a.slots[28].number=n(r)},10)),1!==a.slots[29].state&&(a.slots[29].interval=e(function(){return a.slots[29].number=n(r)},10)),1!==a.slots[30].state)return a.slots[30].interval=e(function(){return a.slots[30].number=n(r)},10)}catch(p){}finally{t.Workspace.activate=!0}},stop:function(){var a,n,o,s,i,l,c,u,p;if(n=this.getActivePrize(),n.complete_once)for(a=[],u=n.slots,s=0,l=u.length;l>s;s++){for(o=u[s],e.cancel(o.interval);a.contains(o.number);)o.number=this.random(this.candidatesArray());0===o.state&&(o.state=1),o.activate=!1,this.addWaiver(o.number),a.push(o.number)}else for(p=n.slots,i=0,c=p.length;c>i;i++)o=p[i],o.activate&&(e.cancel(o.interval),o.state=1,o.activate=!1,this.addWaiver(o.number));return t.Workspace.activate=!1,r.saveWorkspace()},candidatesArray:function(){var e,r,a,n,o,s,i,l,c;for(e=[],i=t.Workspace.baseCandidates,n=0,s=i.length;s>n;n++)for(a=i[n],r=o=l=a.start,c=a.end;c>=l?c>=o:o>=c;r=c>=l?++o:--o)t.Workspace.waivers.contains(r)||e.contains(r)||e.push(r);return t.Workspace.candidates=e,e},addWaiver:function(e){return t.Workspace.waivers.push(e)},random:function(t){return t[Math.floor(Math.random()*t.length)]},basedataPath:function(){return t.BasePath+BasedataPath},basedataFile:function(){return t.BasePath+BasedataPath+BasedataFile},workspacePath:function(){return t.BasePath+WorkspacePath},updatePathConfig:function(){var e;return t.BasePath&&(e=require("fs"),t.BasedataFile=t.BasePath+BasedataFile,t.WorkspacePath=t.BasePath+WorkspacePath,t.ImagePath=t.BasePath+ImagePath,!e.existsSync(t.WorkspacePath))?e.mkdirSync(t.WorkspacePath):void 0},isCurrentPrizeDone:function(){var t,e,r,a,n;for(t=this.getActivePrize(),n=t.slots,r=0,a=n.length;a>r;r++)if(e=n[r],2===e.state)return!1;return!0}}}]);